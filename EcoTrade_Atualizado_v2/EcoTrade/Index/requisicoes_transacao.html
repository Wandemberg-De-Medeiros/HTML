{% load static %}
{% load mathfilters %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoTrade - Requisições de Transação</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{% static 'style.css' %}"> 
    <link rel="stylesheet" href="{% static 'requisicoes.css' %}">
</head>
<body>

<div class="dashboard-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>EcoTrade</h3>
            <p>Créditos de Carbono</p>
        </div>
        
        <nav class="main-nav">
    <ul>
        <li class="{% if active_page == 'dashboard' %}active{% endif %}"><a href="{% url 'dashboard' %}"><i class="fas fa-home"></i> Home</a></li>
        
        <li class="{% if active_page == 'cadastro' %}active{% endif %}"><a href="{% url 'cadastro' %}"><i class="fas fa-user-plus"></i> Cadastro de Usuários</a></li>

        {% if user_tipo == 'Administrador' %}
            <li class="{% if active_page == 'requisicoes_registro' %}active{% endif %}">
                <a href="{% url 'requisicoes_registro' %}">
                    <i class="fas fa-check-circle"></i> Requisições de Registro
                    {% if pendencias > 0 %}<span class="badge">{{ pendencias }}</span>{% endif %}
                </a>
            </li>
            <li class="{% if active_page == 'requisicoes_transacao' %}active{% endif %}">
                <a href="{% url 'requisicoes_transacao' %}">
                    <i class="fas fa-exchange-alt"></i> Requisições Compra/Venda
                </a>
            </li>
        {% else %}
            <li class="{% if active_page == 'registro_creditos' %}active{% endif %}">
                <a href="{% url 'registro_creditos' %}"><i class="fas fa-leaf"></i> Registro de Créditos</a>
            </li>
            <li class="{% if active_page == 'transacoes' %}active{% endif %}">
                <a href="{% url 'transacoes' %}"><i class="fas fa-exchange-alt"></i> Comprar/Vender Créditos</a>
            </li>
        {% endif %}
        
        <li><a href="{% url 'sair' %}"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
    </ul>
</nav>
    </aside>

    <main class="main-content">
        <header class="header">
            <h2>Auditoria: Requisições de Compra e Venda</h2>
            <div class="user-info">
                <span class="user-role">Tipo: {{ user_tipo }}</span>
                <i class="fas fa-cog"></i> 
            </div>
        </header>

        {% if mensagem_sucesso %}
            <p class="alert-box success-box">{{ mensagem_sucesso }}</p>
        {% endif %}

        {% if mensagem_erro %}
            <p class="alert-box error-box">{{ mensagem_erro }}</p>
        {% endif %}

        <section class="content-section requisicoes-section">
            <h3>Transações Pendentes (Marketplace → Auditor)</h3>

            {% if requisicoes %}
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID Req.</th>
                                <th>Tipo</th>
                                <th>Comprador</th>
                                <th>Vendedor</th>
                                <th>Origem Crédito</th>
                                <th>Volume (tCO2e)</th>
                                <th>Preço Unit. (R$)</th>
                                <th>Total (R$)</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for req in requisicoes %}
                            <tr>
                                <td>#{{ req.id }}</td>
                                <td class="type-compra">{{ req.tipo_requisicao }}</td>
                                <td>{{ req.usuario_origem.nome }}</td>
                                <td>{{ req.credito.produtor.nome }}</td>
                                <td>{{ req.credito.origem }}</td>
                                <td>{{ req.volume }}</td>
                                <td>R$ {{ req.preco_un|floatformat:2 }}</td>
                                <td>R$ {{ req.volume|mul:req.preco_un|floatformat:2 }}</td>
                                <td class="action-buttons">
                                    <form method="POST" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="req_id" value="{{ req.id }}">
                                        <button type="submit" name="acao" value="aprovar" class="btn-action btn-approve">Aprovar</button>
                                        <button type="submit" name="acao" value="rejeitar" class="btn-action btn-reject">Rejeitar</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert-box info-box">
                    Não há requisições de transação pendentes no momento.
                </div>
            {% endif %}
        </section>
    </main>
</div>

<style>
.error-box {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
    padding: 15px;
    border-radius: 5px;
    margin-bottom: 20px;
}
</style>

</body>
</html>
